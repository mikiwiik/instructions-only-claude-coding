name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-deps:
    name: Validate Pinned Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Validate npm pinned versions
        run: ./scripts/validate-pinned-deps.sh

      - name: Validate GitHub Actions versions
        run: ./scripts/validate-action-versions.sh

  commitlint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0  # Need full history to validate all PR commits

      - name: Validate PR commits
        uses: wagoid/commitlint-github-action@b948419dd99f3fd78a6548d48f94e3df7f6bf3ed # v6.2.1
        with:
          configFile: commitlint.config.mjs

  build:
    needs: validate-deps
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [22.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        fetch-depth: 0

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Security Audit
      run: npm audit --audit-level=moderate
      continue-on-error: true

    - name: Generate Security Audit Report
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      run: |
        mkdir -p reports
        npm audit --json > reports/audit-report.json || true
        echo "## NPM Audit Report" > reports/audit-summary.md
        echo "" >> reports/audit-summary.md
        npm audit >> reports/audit-summary.md || true

    - name: Upload Security Audit Report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      with:
        name: security-audit-report
        path: reports/
        retention-days: 30

    - name: Run type checking
      run: npm run type-check

    - name: Run linting
      run: npm run lint -- --max-warnings 1

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Coverage Threshold Check
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      run: |
        COVERAGE=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('./coverage/coverage-summary.json')).total.lines.pct)")
        echo "Coverage: ${COVERAGE}%"
        if [ $COVERAGE -lt 90 ]; then
          echo "‚ùå Coverage ${COVERAGE}% is below 90% threshold"
          exit 1
        else
          echo "‚úÖ Coverage ${COVERAGE}% meets 90% threshold"
        fi

    - name: Jest Coverage Comment
      uses: MishaKav/jest-coverage-comment@174f9cbf582b7cc2a7a3acce14dcfc8362e9d37f # v1.0.29
      if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        coverage-summary-path: ./coverage/coverage-summary.json
        junitxml-path: ./coverage/junit.xml
        junitxml-title: Test Results

    - name: Build application
      run: npm run build

    - name: Skip SonarCloud for Dependabot
      if: github.actor == 'dependabot[bot]'
      run: |
        echo "‚ÑπÔ∏è  Skipping SonarCloud analysis for Dependabot PR"
        echo "üìã Reason: Dependabot PRs don't have access to SONAR_TOKEN secret"
        echo "‚úÖ SonarCloud will run on main branch after merge"
        echo ""
        echo "All other quality checks (lint, test, type-check) still run on this PR"

    # SonarCloud analysis runs only once per PR on ubuntu job (not on macos)
    # Matrix conditions ensure it runs on ubuntu-latest only (SonarCloud requires Linux)
    # Dependabot check excludes Dependabot PRs (no access to SONAR_TOKEN secret)
    - name: Generate ESLint Report
      run: npm run lint -- --format json --output-file eslint-report.json || true
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'

    - name: SonarCloud Analysis
      uses: SonarSource/sonarqube-scan-action@0303d6b62e310685c0e34d0b9cde218036885c4d
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x' && github.actor != 'dependabot[bot]'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: Upload coverage reports
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      with:
        name: coverage-report
        path: |
          coverage/
          !coverage/.nyc_output
        retention-days: 30

    - name: Upload build artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '22.x'
      with:
        name: build-artifacts
        path: |
          .next/
          !.next/cache/
        retention-days: 7

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

    - name: Setup Node.js 22.x
      uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run E2E tests
      run: npm run test:e2e
      env:
        CI: true
        USE_IN_MEMORY_STORE: 'true'  # Use in-memory store instead of Redis for E2E

    - name: Upload Playwright Report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload Test Results
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      if: always()
      with:
        name: playwright-test-results
        path: test-results/
        retention-days: 30

  build-summary:
      name: Build and Test
      runs-on: ubuntu-latest
      needs: [build, e2e-tests]
      if: always()

      steps:
      - name: Check build matrix success
        run: |
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "All build matrix jobs and E2E tests completed successfully"
            exit 0
          else
            echo "One or more build matrix jobs or E2E tests failed"
            exit 1
          fi
